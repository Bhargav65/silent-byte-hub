<!DOCTYPE html> 
<html lang="en"> 

<head> 
	<meta charset="UTF-8"> 
	<meta name="viewport" content= 
		"width=device-width, initial-scale=1.0"> 
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link type="text/css" rel="stylesheet" href="/css/chat.css" />
	<title>Chat Template UI using HTML and CSS</title> 
</head> 

<body> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.waves.min.js"></script>
	<div id="vanta-canvas">
		<br>
		<br>
   
    
		<div class="chat-container">
      <button class="button2" id="disconnectButton1" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="46" viewBox="0 0 46 46" height="46" fill="none" class="svg-icon">
          <path stroke-width="2" stroke-linecap="round" stroke="#fff" fill-rule="evenodd" d="m14.5037 27.0715c.819-.634 1.7094-1.1699 2.653-1.597.7621-.3521 1.2557-1.1094 1.2699-1.9488-.0073-1.1346.7466-2.1517 1.8673-2.3279 1.7701-.2782 3.5728-.2785 5.3429-.0005 1.1206.1759 1.8744 1.193 1.8669 2.3274.0206.8307.5066 1.5791 1.257 1.9359.981.4173 1.9093.9489 2.7657 1.5838.8765.5876 2.0467.4715 2.791-.2769l2.2507-2.2507c.4294-.4283.6617-1.0157.6414-1.6219-.0308-.5985-.314-1.1559-.7793-1.5337-2.5842-2.0976-5.6309-3.5496-8.888-4.2357-2.9976-.6659-6.1047-.6655-9.1023.0009-3.2453.7041-6.2835 2.1503-8.87655 4.2253l-.12568.1256c-.38501.38-.60996.8929-.62872 1.4334-.02687.6011.20148 1.1854.62847 1.6092l2.25008 2.2501c.7307.7914 1.9343.9202 2.8162.3015z" clip-rule="evenodd">
          </path>
        </svg>
      </button>
        <div id="room-selection-container" id="connect-button" style="display: flex;">
          
          <div class="circle-container1" id="call-container">

            <button id="call">
              <svg height="25px" version="1.1" viewBox="-2 -2 22 20 " xmlns="http://www.w3.org/2000/svg" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns" xmlns:xlink="http://www.w3.org/1999/xlink" id="call1"><title/><desc/><defs/><g fill="none" fill-rule="evenodd" id="Page-1" stroke="none" stroke-width="1"><g fill="#000000" id="Icons-Communication" transform="translate(-85.000000, -126.000000)"><g id="phone" transform="translate(85.000000, 126.000000)"><path d="M3.6,7.8 C5,10.6 7.4,12.9 10.2,14.4 L12.4,12.2 C12.7,11.9 13.1,11.8 13.4,12 C14.5,12.4 15.7,12.6 17,12.6 C17.6,12.6 18,13 18,13.6 L18,17 C18,17.6 17.6,18 17,18 C7.6,18 0,10.4 0,1 C0,0.4 0.4,0 1,0 L4.5,0 C5.1,0 5.5,0.4 5.5,1 C5.5,2.2 5.7,3.4 6.1,4.6 C6.2,4.9 6.1,5.3 5.9,5.6 L3.6,7.8 L3.6,7.8 Z" id="Shape"/></g></g></g></svg>
            </button>
          </div>
          <br>
            <div class="circle-container" id="video-container">

          <button id="connect-button">
            <svg id="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="30px" fill="none" viewBox="0 0 664 663">
              <path d="m8 12h22c2.2 0 4 1.8 4 4v16c0 2.2-1.8 4-4 4h-22c-2.2 0-4-1.8-4-4v-16c0-2.2 1.8-4 4-4z" fill="#4caf50"/>
              <path d="m44 35-10-6v-10l10-6z" fill="#388e3c"/>
            </svg>
          </button>
        </div>
      </div>
      <br>
      <br>
      <br>
			<div class="message-container"> 
				
				
              
                  
			</div> 
            <div class="message receiver-message" id="loading" style="display: none;"> 
                
                <img src='/avatar1.avif'alt="Sender Avatar"
                    class="avatar"> 
                    <div class="typing-loader"></div>            
                </div>
			<div class="message"> 
                
				<input type="text"
					placeholder="Type your message..." id="messageInput" autocomplete="off" class="input1" style="font-family:'Helvetica', 'Arial', sans-serif; "> 
					<button id="sendButton" onclick="sendMessage()">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 664 663">
						  <path
							fill="none"
							d="M646.293 331.888L17.7538 17.6187L155.245 331.888M646.293 331.888L17.753 646.157L155.245 331.888M646.293 331.888L318.735 330.228L155.245 331.888"
						  ></path>
						  <path
							stroke-linejoin="round"
							stroke-linecap="round"
							stroke-width="33.67"
							stroke="#6c6c6c"
							d="M646.293 331.888L17.7538 17.6187L155.245 331.888M646.293 331.888L17.753 646.157L155.245 331.888M646.293 331.888L318.735 330.228L155.245 331.888"
						  ></path>
						</svg>
					  </button>	
                    		</div>
                       
		</div> 
    <div id="video-chat-container" class="video-position" style="display:none">
      <video id="local-video" autoplay="autoplay" muted="muted"></video>
      <video id="remote-video" autoplay="autoplay"></video>
      <button class="button1" id="disconnectButton">
        <svg xmlns="http://www.w3.org/2000/svg" width="46" viewBox="0 0 46 46" height="46" fill="none" class="svg-icon">
          <path stroke-width="2" stroke-linecap="round" stroke="#fff" fill-rule="evenodd" d="m14.5037 27.0715c.819-.634 1.7094-1.1699 2.653-1.597.7621-.3521 1.2557-1.1094 1.2699-1.9488-.0073-1.1346.7466-2.1517 1.8673-2.3279 1.7701-.2782 3.5728-.2785 5.3429-.0005 1.1206.1759 1.8744 1.193 1.8669 2.3274.0206.8307.5066 1.5791 1.257 1.9359.981.4173 1.9093.9489 2.7657 1.5838.8765.5876 2.0467.4715 2.791-.2769l2.2507-2.2507c.4294-.4283.6617-1.0157.6414-1.6219-.0308-.5985-.314-1.1559-.7793-1.5337-2.5842-2.0976-5.6309-3.5496-8.888-4.2357-2.9976-.6659-6.1047-.6655-9.1023.0009-3.2453.7041-6.2835 2.1503-8.87655 4.2253l-.12568.1256c-.38501.38-.60996.8929-.62872 1.4334-.02687.6011.20148 1.1854.62847 1.6092l2.25008 2.2501c.7307.7914 1.9343.9202 2.8162.3015z" clip-rule="evenodd">
          </path>
        </svg>
      </button>
    </div>
    
		<form method="post" action="/logout" id="logout">
      <input type="hidden" id="hide" name="hide">
    </form>
    <button type="button" class="button" style="margin-bottom:650px; margin-left: 1000px;" onclick="submitForm()">
      <span class="button__text">Leave room</span>
      <span class="button__icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
      </span>
  </button>
    
	</div>
	
    <div id="toastBox"></div>
	<script>
        VANTA.WAVES({
          el: "#vanta-canvas",
          mouseControls: true,
          touchControls: true,
          gyroControls: false,
          minHeight: 200.00,
          minWidth: 200.00,
          scale: 1.00,
          scaleMobile: 1.00,
          color: 0x151515,
          zoom: 0.78
        })
    </script>
    <script src="/socket.io/socket.io.js"></script> <!-- Ensure Socket.IO client script is loaded -->

    <script>
      window.addEventListener('beforeunload', function(event) {
        alert("hello")
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/logout', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({ hide: id }));
    });


      const messageInput = document.getElementById('messageInput');
     let typingTimeout;

     function hideTypingLoader() {
      document.getElementById('loading').style.display='none'
}

	messageInput.addEventListener('input', () => {
		if (messageInput.value.trim() !== '') {
		socket.emit('typing1',(id));
	} else {
		socket.emit('stop typing1',(id));
	}

  
  socket.on(`${id}user typing1`, (username) => {
	document.getElementById('loading').style.display='flex'
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(hideTypingLoader, 1000)
    });

    socket.on(`${id}user stopped typing1`, (username) => {
		document.getElementById('loading').style.display='none'
    clearTimeout(typingTimeout);
	});
  hideTypingLoader();
});


socket.on(`${id}user typing1`, (username) => {
	document.getElementById('loading').style.display='flex'
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(hideTypingLoader, 1000)
    });

    socket.on(`${id}user stopped typing1`, (username) => {
		document.getElementById('loading').style.display='none'
    clearTimeout(typingTimeout);
	});
  hideTypingLoader();
    </script>
    

	<script>

let infoMsg = '<i class="fa-solid fa-circle-info"></i> you are logged out';        
let toastVisible = false;

function showToast(msg) {
      if(!toastVisible){
        let toast = document.createElement("div");
        toast.classList.add("toast");
        toast.innerHTML = msg;
        toastBox.appendChild(toast);
    
        if (msg.includes("info")) {
          toast.classList.add("info")
        }
  
        toastVisible = true;
        
        setTimeout(() => {
          toast.remove();
          toastVisible = false;
          window.location.replace("/");
        }, 5000);
      }
			
		}
  function showToast2(msg) {
			let toast = document.createElement("div");
			toast.classList.add("toast");
			toast.innerHTML = msg;
			toastBox.appendChild(toast);
	
			if (msg.includes("info")) {
				toast.classList.add("info")
			}
	
			setTimeout(() => {
				toast.remove();
			}, 5000);
		}

	

		document.getElementById("messageInput").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("sendButton").click();
    }
});
const id= localStorage.getItem('id1');
	let socket = io(); 
		  function sendMessage() {
            var messageInput = document.getElementById('messageInput');
            var messageText = messageInput.value;
            if (messageText.trim() !== '') {
                var messageContainer = document.querySelector('.message-container');
                var newMessage = document.createElement('div');
                newMessage.classList.add('message', 'sender-message');
                newMessage.innerHTML = '<img src="/avatar.avif" alt="Sender Avatar" class="avatar">' + messageText;
                messageContainer.appendChild(newMessage);
                messageInput.value = '';
                messageContainer.scrollTop = messageContainer.scrollHeight;
				socket.emit('send message1',  {message:messageText,id:id}); 
            }
        }
		
		socket.on(`${id}0`, (chat) => {
			var messageContainer = document.querySelector('.message-container');
            var newMessage = document.createElement('div');
            newMessage.classList.add('message', 'receiver-message');
            newMessage.innerHTML = '<img src="/avatar1.avif" alt="Sender Avatar" class="avatar">' + chat.message;
			messageContainer.appendChild(newMessage);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        });


        function submitForm() {
    const hide = document.getElementById('hide');
    hide.value = id;
    const form = document.getElementById('logout');
    form.submit();
}
    socket.on(`logout${id}`, (username) => { 
			if (username === "logout") {
				showToast(infoMsg)
			}
			
		});
	</script>








<script src="/socket.io/socket.io.js"></script>
   

      <script>
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const connectButton = document.getElementById('connect-button');
        const disconnectButton = document.getElementById('disconnectButton');
        const callButton = document.getElementById('call');

        let localStream;
        let peerConnection;
        const roomId = id; 
        const mediaConstraints = { audio: true, video: { width: 1280, height: 720 } };
        const roomSelectionContainer = document.getElementById('room-selection-container')
        const videoChatContainer = document.getElementById('video-chat-container')
        const disconnectButton1 = document.getElementById('disconnectButton1');
        const call_container=document.getElementById('call-container')
        const video_container=document.getElementById('video-container')


        connectButton.addEventListener('click', () => {
          cnt=1
          mediaConstraints.video={ width: 1280, height: 720 }
          roomSelectionContainer.style.display = 'none'
          videoChatContainer.style.display = 'block'
          socket.emit('alert_call1',{id:id,type:"video"})
          startCall()
        })

        callButton.addEventListener('click', () => {
          cnt=2
          roomSelectionContainer.style.display = 'none'
          callButton.style.display = 'block'
          disconnectButton1.style.display='flex'
          socket.emit('alert_call1',{id:id,type:"audio"})
          mediaConstraints.video = false;
          startCall()
        })


// -------------------------------MAIN FUNCTION FOR VIDEO AND AUDIO CALLING USING WEBRTC------------------------


        async function startCall() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                localVideo.srcObject = localStream;
                socket.emit('join', roomId);
                setupPeerConnection();
                addLocalTracksToPeerConnection();
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('offer', { type: 'offer', sdp: offer, roomId });
            } catch (error) {
                console.error('Error starting call:', error);
            }
        }

        function setupPeerConnection() {
            const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
            peerConnection = new RTCPeerConnection(config);
            peerConnection.onicecandidate = handleICECandidateEvent;
            peerConnection.ontrack = handleTrackEvent;
        }

        function addLocalTracksToPeerConnection() {
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        }

        function handleICECandidateEvent(event) {
            if (event.candidate) {
                socket.emit('ice-candidate', { candidate: event.candidate, roomId });
            }
        }

        function handleTrackEvent(event) {
            remoteVideo.srcObject = event.streams[0];
        }

        socket.on('offer', async (data) => {
            if (!peerConnection) setupPeerConnection();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', { type: 'answer', sdp: answer, roomId });
        });

        socket.on('answer', async (data) => {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
        });

        socket.on('ice-candidate', async (data) => {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            } catch (error) {
                console.error('Error adding received ice candidate', error);
            }
        });

// ------------------------------------------------------------------------------------------------------------------------------//

 //-----------------------------------------------DISCONNECTING CALL ------------------------------------------------------------

        function handleDisconnect() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            roomSelectionContainer.style.display = 'block';
            videoChatContainer.style.display = 'none';
            disconnectButton1.style.display='none'
            call_container.style.display='flex'
            video_container.style.display='flex'
        }


        socket.on(`disconnect_call${id}1`,()=>{
 
          handleDisconnect()
        })
        
        disconnectButton.addEventListener('click', () => {
          socket.emit('disconnect_call',(id));
          handleDisconnect();
          disconnectButton1.style.display='none'
        
        });
        
        disconnectButton1.addEventListener('click', () => {
          socket.emit('disconnect_call',(id));
          handleDisconnect();
          disconnectButton1.style.display='none'
        });
        
        
        socket.on(`alert${id}`,(val)=>{
        
          if (window.getComputedStyle(videoChatContainer).display === 'none' && val==="video") {
          showToast2('<i class="fa-solid fa-circle-info"></i> User is requesting for video call. Please click on video button to take the call')
          call_container.style.display='none'
          }
          else if(val==="audio" && window.getComputedStyle(disconnectButton1).display === 'none' ){
            showToast2('<i class="fa-solid fa-circle-info"></i> User is requesting for audio call. Please click on video button to take the call')
            video_container.style.display='none'
        
          }
        })
//----------------------------------------------------------------------------------------------------------------------------//



      </script>

      <script>

        //--------------------------------MAKING THE VIDEO SCREEN MOVABLE------------------------------------

        let offsetX, offsetY;
  
        function startDrag(e) {
          offsetX = e.clientX - videoChatContainer.getBoundingClientRect().left;
          offsetY = e.clientY - videoChatContainer.getBoundingClientRect().top;
          document.addEventListener('mousemove', drag);
          document.addEventListener('mouseup', endDrag);
        }
        
        function drag(e) {
          videoChatContainer.style.left = `${e.clientX - offsetX}px`;
          videoChatContainer.style.top = `${e.clientY - offsetY}px`;
        }
        
        function endDrag() {
          document.removeEventListener('mousemove', drag);
          document.removeEventListener('mouseup', endDrag);
        }
        
        videoChatContainer.addEventListener('mousedown', startDrag);
        </script>
</body> 

</html>
