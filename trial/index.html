<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Call App</title>
<style>
  /* style.css */
body {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  background-color: #f0f0f0;
}

.room-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

input, button {
  margin: 10px;
  padding: 10px;
  font-size: 16px;
}

.video-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

video {
  width: 600px;
  margin: 10px;
  border: 2px solid #ddd;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

</style></head>
<body>
  <div class="video-container">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io('/');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const peerConnectionConfig = {
      'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]
    };

    let localStream;
    let remoteStream;
    let peerConnection;
    const roomId = window.location.pathname.split('/').pop();

    // Get user media
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;
        localVideo.srcObject = stream;

        socket.emit('join', roomId);

        socket.on('user-connected', userId => {
          callUser(userId);
        });

        socket.on('offer', handleOffer);
        socket.on('answer', handleAnswer);
        socket.on('ice-candidate', handleIceCandidate);
      })
      .catch(error => {
        console.error('Error accessing media devices.', error);
      });

    function callUser(userId) {
      peerConnection = new RTCPeerConnection(peerConnectionConfig);

      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          socket.emit('ice-candidate', {
            candidate: event.candidate,
            roomId: roomId
          });
        }
      };

      peerConnection.ontrack = event => {
        remoteVideo.srcObject = event.streams[0];
      };

      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      peerConnection.createOffer()
        .then(offer => {
          return peerConnection.setLocalDescription(offer);
        })
        .then(() => {
          socket.emit('offer', {
            type: 'offer',
            sdp: peerConnection.localDescription,
            roomId: roomId
          });
        })
        .catch(error => {
          console.error('Error creating offer.', error);
        });
    }

    function handleOffer(data) {
      if (!peerConnection) {
        peerConnection = new RTCPeerConnection(peerConnectionConfig);

        peerConnection.onicecandidate = event => {
          if (event.candidate) {
            socket.emit('ice-candidate', {
              candidate: event.candidate,
              roomId: roomId
            });
          }
        };

        peerConnection.ontrack = event => {
          remoteVideo.srcObject = event.streams[0];
        };

        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
      }

      peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp))
        .then(() => {
          return peerConnection.createAnswer();
        })
        .then(answer => {
          return peerConnection.setLocalDescription(answer);
        })
        .then(() => {
          socket.emit('answer', {
            type: 'answer',
            sdp: peerConnection.localDescription,
            roomId: roomId
          });
        })
        .catch(error => {
          console.error('Error handling offer.', error);
        });
    }

    function handleAnswer(data) {
      peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp))
        .catch(error => {
          console.error('Error setting remote description.', error);
        });
    }

    function handleIceCandidate(data) {
      peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate))
        .catch(error => {
          console.error('Error adding ICE candidate.', error);
        });
    }
  </script>
</body>
</html>
